#!/bin/sh
# VERSION: 2024022202
set -eu
umask 0022

QUIET=0
SIMPLE=0
SOLO=0
EXTRACT=0
RSHELL=0
NOMARKER=0

while [ $# -gt 0 ]
do
  case "${1}" in
    nomarker)
      NOMARKER=1
      ;;
    quiet)
      QUIET=1
      ;;
    simple)
      SIMPLE=1
      ;;
    solo)
      SOLO=1
      ;;
    exctract)
      EXTRACT=1
      ;;
    sh|shell)
      RSHELL=1
  esac
  shift
done

cd /
SOURCE="${SOURCE:-/src}"

[ ${RSHELL} -eq 0 ] || exec /bin/sh
if [ ${EXTRACT} -eq 1 ]
then
  if [ -d /extract ]
  then
    if [ -z "$(ls -A /extract 2>/dev/null)" ]
    then
      rsync -aq "${SOURCE}/deploy/" "/extract/" || exit 10
    else
      printf -- "ERROR: /extract directory is not empty ...\n"
      exit 2
    fi
  else
    printf -- "ERROR: missing /extract output directory ...\n"
    exit 1
  fi
  exit 0
fi

_success=0
while true
do
  _error='missing DEPLOY_TO variable'
  [ -n "${DEPLOY_TO:-}" ] || break

  _error='missing source deploy directory'
  [ -d "${SOURCE}/deploy" ] || break

  [ -f "${SOURCE}/exclude" ] || touch "${SOURCE}/exclude"

  _error='missing DEPLOY_TO directory'
  [ -d "${DEPLOY_TO}" ] || break

  if [ -e "${DEPLOY_TO}/current" ] && [ -L "${DEPLOY_TO}/current" ]
  then
    _error='unable to remove "current" symbolic link'
    rm -f -- "${DEPLOY_TO}/current" || break
  fi

  if [ ! -e "${DEPLOY_TO}/current" ]
  then
    _error='unable to create "current" directory'
    mkdir -p "${DEPLOY_TO}/current" || break
  fi

  _error='object "current" exists but is not a directory'
  [ -d "${DEPLOY_TO}/current" ] || break

  if [ -e "${DEPLOY_TO}/stage" ]
  then
    _error='unable to remove "stage" directory'
    rm -rf -- "${DEPLOY_TO}/stage" || break
  fi

  DEPLOY="current"
  STAGE="stage"
  

  [ ${QUIET} -eq 1 ] || printf "DEPLOYING STAGE FROM \"%s\" TO \"%s\"\n" "${SOURCE}/deploy" "${DEPLOY_TO}/${STAGE}"
  _error="stage deploy failed"
  rsync -aq --delete --exclude-from "${SOURCE}/exclude" "${SOURCE}/deploy/" "${DEPLOY_TO}/${STAGE}/" || break

  [ ${QUIET} -eq 1 ] || printf "SWITCHING FROM \"%s\" TO \"%s\" ...\n" "${STAGE}" "${DEPLOY}"
  if [ ${SIMPLE} -eq 1 ]
  then
    printf -- "SIMPLE SWITCH (FOR TESTING ONLY)\n"
    mv -f -- "${DEPLOY_TO}/${DEPLOY}" "${DEPLOY_TO}/${DEPLOY}.switch"
    mv -f -- "${DEPLOY_TO}/${STAGE}" "${DEPLOY_TO}/${DEPLOY}"
    rm -rf -- "${DEPLOY_TO}/${DEPLOY}.switch"
  else
    _error='switching from stage to current failed'
    mv.ex "${DEPLOY_TO}/${STAGE}" "${DEPLOY_TO}/${DEPLOY}" || break
  fi
  [ ${QUIET} -eq 1 ] || printf "CURRENT: %s\n" "${DEPLOY_TO}/${DEPLOY}"

  _success=1

  # non critical
  if [ -e "${DEPLOY_TO}/stage" ]
  then
    rm -rf -- "${DEPLOY_TO}/stage" || printf -- 'unable to purge "stage" directory\n'
  fi

  if [ -d "${DEPLOY_TO}/a" ]
  then
    rm -rf -- "${DEPLOY_TO}/a" || printf -- 'purging of v2 stage "a" directory failed\n'
  fi

  if [ -d "${DEPLOY_TO}/b" ]
  then
    rm -rf -- "${DEPLOY_TO}/b" || printf -- 'purging of v2 stage "b" directory failed\n'
  fi

  break
done

if [ ${_success} -ne 1 ]
then
 printf "ERROR: %s\n" "${_error}"
 exit 1
fi 

[ ${NOMARKER} -eq 1 ] || date "+%s.%N" > "${DEPLOY_TO}/.marker"

[ ${QUIET} -eq 1 ] || printf "DEPLOYED: $(date -R)\n"
[ ${SOLO} -eq 1 ] || sleep infinity
